<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agent Build Session</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background-color: #f7f7f7;
    }
    header {
      background-color: #fff;
      padding: 1rem;
      border-bottom: 1px solid #ddd;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      max-width: 1000px;
      margin: 0 auto;
    }
    input[type="text"] {
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      flex-grow: 1;
    }
    button {
      padding: 0.5rem 1rem;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background-color: #0056b3;
    }
    #connect-btn.connected {
      background-color: #28a745;
    }
    main {
      flex-grow: 1;
      overflow-y: auto;
      padding: 1rem;
      max-width: 1000px;
      width: 100%;
      margin: 0 auto;
      box-sizing: border-box;
    }
    #chat-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .message {
      padding: 0.8rem;
      border-radius: 8px;
      max-width: 80%;
      word-wrap: break-word;
    }
    .agent-message {
      background-color: #e9e9eb;
      align-self: flex-start;
    }
    .system-message {
      background-color: #fffbe6;
      align-self: center;
      text-align: center;
      width: 100%;
      font-style: italic;
      color: #666;
    }
    .user-message {
      background-color: #d1ecf1;
      align-self: flex-end;
    }
    .message strong {
      color: #333;
    }
    .message pre {
      background-color: #2d2d2d;
      color: #f8f8f2;
      padding: 1rem;
      border-radius: 4px;
      white-space: pre-wrap;
    }
    #input-area {
      display: none;
      padding: 0.5rem;
      border-top: 1px solid #ddd;
      background: #fff;
      max-width: 1000px;
      width: 100%;
      margin: 0 auto;
      display: flex;
      gap: 0.5rem;
    }
    #user-input {
      flex-grow: 1;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
  </style>
</head>

<body>
  <header>
    <div class="controls">
      <input type="text" id="problem-input" placeholder="Enter the problem to solve..." />
      <button id="connect-btn">üîå Connect</button>
      <button id="start-btn" disabled>‚ñ∂Ô∏è Start Build</button>
    </div>
  </header>

  <main id="chat-container"></main>

  <div id="input-area">
    <input type="text" id="user-input" placeholder="Enter your reply..." />
    <button id="send-btn">Send</button>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const connectBtn = document.getElementById("connect-btn");
      const startBtn = document.getElementById("start-btn");
      const problemInput = document.getElementById("problem-input");
      const chatContainer = document.getElementById("chat-container");
      const inputArea = document.getElementById("input-area");
      const userInput = document.getElementById("user-input");
      const sendBtn = document.getElementById("send-btn");

      let socket = null;

      // --- WebSocket Connection ---
      connectBtn.addEventListener("click", () => {
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.close();
          return;
        }

        const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
        const wsUrl = `${wsProtocol}://${window.location.host}/ws`;
        socket = new WebSocket(wsUrl);

        socket.onopen = () => {
          connectBtn.textContent = "üü¢ Connected";
          connectBtn.classList.add("connected");
          startBtn.disabled = false;
          displayMessage("<strong>WebSocket connected.</strong>", "system");
        };

        socket.onmessage = (event) => {
          const msg = JSON.parse(event.data);
          if (msg.type === "sys" || msg.type === "error" || msg.type === "done") {
            displayMessage(`<strong>${msg.msg}</strong>`, "system");
            if (msg.type === "done") {
              inputArea.style.display = "none";
            }
          } else if (msg.type === "prompt") {
            displayMessage(`<strong>Agent requests:</strong> ${msg.msg}`, "system");
            inputArea.style.display = "flex";
            userInput.focus();
          } else if (msg.type === "user") {
            displayMessage(`<strong>You:</strong><br>${msg.msg}`, "user");
          } else {
            displayMessage(formatAgentMessage(msg), "agent");
          }
        };

        socket.onclose = () => {
          connectBtn.textContent = "üîå Connect";
          connectBtn.classList.remove("connected");
          startBtn.disabled = true;
          displayMessage("<strong>WebSocket disconnected.</strong>", "system");
        };

        socket.onerror = (err) => {
          displayMessage("<strong>WebSocket error. Unable to connect.</strong>", "system");
        };
      });

      // --- Start Build ---
      startBtn.addEventListener("click", async () => {
        const problem = problemInput.value.trim();
        if (!problem) {
          alert("Please enter a problem description first.");
          return;
        }

        chatContainer.innerHTML = "";
        displayMessage(`<strong>Starting task:</strong> ${problem}`, "system");

        try {
          const res = await fetch("/init_task", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ problem }),
          });
          const data = await res.json();

          if (!res.ok) {
            displayMessage(`<strong>Error:</strong> ${data.detail}`, "system");
            return;
          }

          displayMessage(`<strong>Task initialized:</strong> ${data.problem}`, "system");
        } catch (err) {
          displayMessage(`<strong>Error initializing task:</strong> ${err.message}`, "system");
        }
      });

      // --- Send user reply ---
      sendBtn.addEventListener("click", async () => {
        const reply = userInput.value.trim();
        if (!reply) return;

        displayMessage(`<strong>You:</strong><br>${reply}`, "user");
        userInput.value = "";
        inputArea.style.display = "none";

        try {
          await fetch("/user-reply", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ content: reply }),
          });
        } catch (err) {
          displayMessage(`<strong>Error sending reply:</strong> ${err.message}`, "system");
        }
      });

      // --- Helper functions ---
      function displayMessage(html, type) {
        const div = document.createElement("div");
        div.classList.add("message", `${type}-message`);
        div.innerHTML = html;
        chatContainer.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function formatAgentMessage(msg) {
        const sender = msg.source || "Agent";
        const content = msg.content || "";
        const sanitized = content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        const formatted = sanitized.replace(
          /```(\w*)\n([\s\S]*?)\n```/g,
          "<pre><code>$2</code></pre>"
        );
        return `<strong>${sender}:</strong><br>${formatted}`;
      }
    });
  </script>
</body>
</html>
